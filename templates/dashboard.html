<!-- SPDX-License-Identifier: LGPL-2.1-or-later -->
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Staging Cycle Overview</h5>
            </div>
            <div class="card-body">
                {% if staging_runs %}
                    {% set latest_run = staging_runs[0] %}
                    <div class="row">
                        <div class="col-md-3">
                            <h6>Current Status</h6>
                            {% if latest_run.status.value == 'running' %}
                                <span class="badge bg-primary fs-6">
                                    <i class="fas fa-spinner fa-spin me-1"></i>Running
                                </span>
                            {% elif latest_run.status.value == 'completed' %}
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check me-1"></i>Completed
                                </span>
                            {% elif latest_run.status.value == 'failed' %}
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-times me-1"></i>Failed
                                </span>
                            {% elif latest_run.status.value == 'cancelled' %}
                                <span class="badge bg-warning fs-6">
                                    <i class="fas fa-ban me-1"></i>Cancelled
                                </span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">
                                    <i class="fas fa-clock me-1"></i>{{ latest_run.status.value.title() }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <h6>Current Step</h6>
                            {% if latest_run.current_step %}
                                <span class="badge bg-info">{{ latest_run.current_step.replace('_', ' ').title() }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <h6>Kernel Tree</h6>
                            {% if latest_run.kernel_tree %}
                                {% if latest_run.kernel_tree == "none" %}
                                    <span class="badge bg-warning text-dark">None (Skipped)</span>
                                {% elif latest_run.kernel_tree == "auto" %}
                                    <span class="badge bg-info text-dark">Auto (Rotating)</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ latest_run.kernel_tree }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <h6>Duration</h6>
                            {% if latest_run.end_time %}
                                <p class="mb-0">{{ ((latest_run.end_time - latest_run.start_time).total_seconds() / 60) | round(1) }} min</p>
                            {% else %}
                                <p class="mb-0">In progress...</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if latest_run.status.value == 'running' %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Step Progress</h6>
                            <div class="progress-container">
                                {% for step in latest_run.steps | sort(attribute='sequence_order') %}
                                <div class="d-flex align-items-center mb-2">
                                    <div class="step-icon me-2">
                                        {% if step.status.value == 'completed' %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% elif step.status.value == 'partial_success' %}
                                            <i class="fas fa-exclamation-circle text-warning"></i>
                                        {% elif step.status.value == 'running' %}
                                            <i class="fas fa-spinner fa-spin text-primary"></i>
                                        {% elif step.status.value == 'failed' %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% else %}
                                            <i class="fas fa-circle text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>{{ step.step_type.value.replace('_', ' ').title() }}</strong>
                                        {% if step.info_message %}
                                            <br><small class="text-warning"><i class="fas fa-info-circle me-1"></i>{{ step.info_message }}</small>
                                        {% endif %}
                                        {% if step.error_message %}
                                            {% if 'Partial success' in step.error_message %}
                                                <br><small class="text-warning">{{ step.error_message }}</small>
                                            {% else %}
                                                <br><small class="text-danger">{{ step.error_message }}</small>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <p>No staging runs yet. Start your first run!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Quick Stats</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ staging_runs|length }}</h4>
                        <small class="text-muted">Total Runs</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">
                            {{ staging_runs | selectattr("status.value", "equalto", "completed") | list | length }}
                        </h4>
                        <small class="text-muted">Successful</small>
                    </div>
                </div>
            </div>
        </div>
        
        {% if user.role.value in ['admin', 'maintainer'] %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-play me-2"></i>Start New Run</h6>
            </div>
            <div class="card-body">
                {% if running_staging %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Staging run #{{ running_staging.id }} is currently running.</strong><br>
                    <small>Cannot start a new run while another is in progress.</small>
                    <div class="mt-2">
                        <a href="/staging/{{ running_staging.id }}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-eye me-1"></i>View Current Run
                        </a>
                        {% if user.role.value in ['admin', 'maintainer'] or user.id == running_staging.user_id %}
                        <form method="post" action="/staging/{{ running_staging.id }}/cancel" class="d-inline">
                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to cancel this staging run?')">
                                <i class="fas fa-times me-1"></i>Cancel Run
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div id="stagingTriggerForm">
                    <div class="mb-3">
                        <label for="kernel_tree" class="form-label">Kernel Tree</label>
                        <select class="form-select" name="kernel_tree" id="kernel_tree">
                            <option value="auto">Auto (Rotate)</option>
                            <option value="none">None (Skip kernel tree update)</option>
                            <option value="next">Linux Next</option>
                            <option value="mainline">Linux Mainline</option>
                            <option value="stable">Linux Stable</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-primary w-100" id="stagingTriggerBtn" onclick="openStagingModal()">
                        <i class="fas fa-rocket me-2"></i>Trigger Staging Run
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Staging Runs</h5>
            </div>
            <div class="card-body">
                {% if staging_runs %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Started By</th>
                                <th>Kernel Tree</th>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Current Step</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for run in staging_runs %}
                            <tr>
                                <td><a href="/staging/{{ run.id }}" class="text-decoration-none">#{{ run.id }}</a></td>
                                <td>{{ run.user.username }}</td>
                                <td>
                                    {% if run.kernel_tree %}
                                        {% if run.kernel_tree == "none" %}
                                            <span class="badge bg-warning text-dark">None</span>
                                        {% elif run.kernel_tree == "auto" %}
                                            <span class="badge bg-info text-dark">Auto</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ run.kernel_tree }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>{{ run.start_time.strftime('%m/%d %H:%M') }}</td>
                                <td>
                                    {% if run.end_time %}
                                        {{ ((run.end_time - run.start_time).total_seconds() / 60) | round(1) }}m
                                    {% else %}
                                        <span class="text-muted">Running...</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if run.status.value == 'running' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-spinner fa-spin me-1"></i>Running
                                        </span>
                                    {% elif run.status.value == 'completed' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Completed
                                        </span>
                                    {% elif run.status.value == 'failed' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>Failed
                                        </span>
                                    {% elif run.status.value == 'cancelled' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-ban me-1"></i>Cancelled
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            {{ run.status.value.title() }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if run.current_step %}
                                        <small class="badge bg-info">{{ run.current_step.replace('_', ' ').title() }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/staging/{{ run.id }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <p>No staging runs found.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Staging Run Modal -->
<div class="modal fade" id="stagingRunModal" tabindex="-1" aria-labelledby="stagingRunModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stagingRunModalLabel">
                    <i class="fas fa-rocket me-2"></i>Starting Staging Run
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="stagingModalContent">
                    <!-- Content will be dynamically updated -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Checking preconditions...</span>
                        </div>
                        <p class="mt-3 mb-0">Checking preconditions...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="stagingModalFooter" style="display: none;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% if staging_runs and staging_runs[0].status.value == 'running' %}
<script>
// Auto-refresh for running staging runs
setTimeout(function() {
    window.location.reload();
}, 30000); // Refresh every 30 seconds
</script>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
let stagingModal = null;

async function openStagingModal() {
    // Get modal instance
    const modalElement = document.getElementById('stagingRunModal');
    if (!stagingModal) {
        stagingModal = new bootstrap.Modal(modalElement);
    }

    // Reset modal content
    document.getElementById('stagingModalContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Checking preconditions...</span>
            </div>
            <p class="mt-3 mb-0">Checking preconditions...</p>
            <small class="text-muted">Verifying GitHub workflow status...</small>
        </div>
    `;

    // Hide footer initially
    document.getElementById('stagingModalFooter').style.display = 'none';

    // Show modal
    stagingModal.show();

    // Check preconditions
    try {
        const response = await fetch('/api/staging/check-workflow', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (response.ok) {
            if (data.can_trigger) {
                // All checks passed - proceed to trigger
                await proceedWithStagingRun();
            } else {
                // Show error in modal
                showModalError(data.reason, data.running_workflows);
            }
        } else if (response.status === 401) {
            // Authentication required
            showModalError('Authentication required. Please refresh the page and try again.');
        } else if (response.status === 403) {
            // Permission denied
            showModalError('You do not have permission to trigger staging runs.');
        } else {
            // Other error
            showModalError(`Error: ${data.detail || 'Failed to check preconditions'}`);
        }
    } catch (error) {
        console.error('Error checking preconditions:', error);
        showModalError('Network error: Failed to check preconditions. Please try again.');
    }
}

function showModalError(message, runningWorkflows = []) {
    const modalContent = document.getElementById('stagingModalContent');
    const modalFooter = document.getElementById('stagingModalFooter');

    let errorHtml = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Cannot Start Staging Run</strong>
            <hr>
            <p class="mb-0">${message}</p>
        </div>
    `;

    // Show running workflows if any
    if (runningWorkflows && runningWorkflows.length > 0) {
        errorHtml += `
            <div class="mt-3">
                <h6>Active GitHub Workflows:</h6>
                <ul class="list-group">
        `;

        for (const workflow of runningWorkflows) {
            const createdAt = new Date(workflow.created_at).toLocaleString();
            errorHtml += `
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Run #${workflow.run_number}</strong><br>
                            <small class="text-muted">Started: ${createdAt}</small>
                        </div>
                        <span class="badge bg-primary">
                            <i class="fas fa-spinner fa-spin me-1"></i>${workflow.status}
                        </span>
                    </div>
                    ${workflow.html_url ? `<a href="${workflow.html_url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-external-link-alt me-1"></i>View on GitHub
                    </a>` : ''}
                </li>
            `;
        }

        errorHtml += `
                </ul>
            </div>
        `;
    }

    modalContent.innerHTML = errorHtml;

    // Show footer with Close button
    modalFooter.style.display = 'block';
}

async function proceedWithStagingRun() {
    const modalContent = document.getElementById('stagingModalContent');
    const kernelTreeSelect = document.getElementById('kernel_tree');
    const kernelTree = kernelTreeSelect.value;

    // Update modal to show progress
    modalContent.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Starting staging run...</span>
            </div>
            <p class="mt-3 mb-0">Starting staging run...</p>
            <small class="text-muted">Kernel tree: ${kernelTree}</small>
        </div>
    `;

    try {
        const response = await fetch('/api/staging/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                kernel_tree: kernelTree
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Success - show success message briefly then redirect
            modalContent.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">Staging Run Started!</h5>
                    <p class="mb-0">Run #${data.staging_run_id} has been initiated successfully.</p>
                    <p class="text-muted">Redirecting...</p>
                </div>
            `;

            // Auto close modal and redirect after 1.5 seconds
            setTimeout(() => {
                stagingModal.hide();
                window.location.href = `/staging/${data.staging_run_id}`;
            }, 1500);
        } else {
            // Error - show message
            showModalError(data.detail || 'Failed to start staging run');
        }
    } catch (error) {
        console.error('Error triggering staging run:', error);
        showModalError('Network error: Failed to start staging run. Please try again.');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded - Modal staging trigger ready');

    // Clean up modal when hidden
    const modalElement = document.getElementById('stagingRunModal');
    modalElement.addEventListener('hidden.bs.modal', function () {
        // Reset button state if needed
        const triggerBtn = document.getElementById('stagingTriggerBtn');
        if (triggerBtn) {
            triggerBtn.disabled = false;
        }
    });
});
</script>

{% endblock %}